# 使用 Snoopy 记录命令操作

## 背景

最近在搞运维安全相关的事情，有服务器操作审计的需求。但是我们穷逼公司又没有钱搞专门的审计设备或者云产品，就想着在操作系统里实现简单的命令记录功能。

搜索了一圈，主要有使用 auditd 服务和 Snoopy 工具两个思路，当然还有其他的方法，但是觉得这俩就够了。其中 Snoopy 的配置简单一些，功能也满足需求，就摸索了一下。

![snoopy](./snoopy.jpg)

## 原理

Snoopy 的原理还是挺简单的，这玩意编译完就是一个.so 的库，然后通过 Linux 的 LD_PRELOAD 机制，在其他程序执行时候加载，并拦截 execve()系统调用，这样凡是通过 execve()执行的动作，都会被拦截并记录一下。

说实话，这种通过 LD_PRELOAD 的玩儿法，我第一次是在一个挖矿程序里见到的，可见技术还是不分善恶的。

## 安装

发现目前主流的 Linux，包管理工具中可以直接安装。我的几个测试环境用到了 CentOS 和 Rocky，在开放 epel-release 后也可以直接通过 yum 或 dnf 安装。

```shell
sudo dnf install snoopy
```

安装过后，会多一个 snoopyctl 的命令，可以通过这个命令来查看配置、查看状态、设置启停等。

## 配置及启动

Snoopy 的配置文件，可以控制存储位置、存储格式等信息，这俩是我们比较关注的。

我需要记录的内容包括 时间、登录名、用户名、工作路径、执行命令等。

Snoopy 的配置文件，默认位于 /etc/snoopy.ini，格式是 ini，注释写得很清楚，如果想自定义的话直接照着示例就能改出来。

根据上面的需求，我设置了如下配置：

```ini
message_format="%{datetime:%H:%M:%S}  [%{tty_username} %{username} cwd:%{cwd} filename:%{filename}]: %{cmdline}"
```

修改配置文件后，通过`snoopyctl conf`可以查看并确认配置，然后通过`snoopyctl enable`来开启 snoopy。

这玩意不是系统服务，而是直接注入到程序执行过程中，所以不需要设置开机自动启动，enable 之后就一直生效的，直到手动 disable 掉或者被手动删除。

## 日志存储

Snoopy 可以将日志存储于文件，一开始我觉得这样挺好，后来发现不是很 OK。因为日志存储的过程是由执行命令的用户“顺带着”完成的，所以日志存储的地址必须对于该用户可写。这样一来，用户就可以轻易地删除或篡改日志了，起不到特别好的审计效果。

默认地，Snoopy 日志选项为`devlog`，也就是写入到 `/dev/log`中，在红帽系系统中，最终落入`/var/log/secure`文件。如果想要对该文件进行长期存储，可使用 logrotate 功能，配置该文件的存储逻辑。在下面的配置中，我每天存储一个日志文件，并保存 120 天

```/etc/logrotate.d/secure
/var/log/secure {
    daily
    missingok
    rotate 120
    compress
    delaycompress
    notifempty
    sharedscripts
    postrotate
        /usr/bin/systemctl -s HUP kill rsyslog.service >/dev/null 2>&1 || true
    endscript
}
```

特别地，需要检查一下其他配置文件，有没有涉及`/var/log/secure`，避免配置项上的冲突。
