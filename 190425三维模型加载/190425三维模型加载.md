# Three.js三维模型加载优化

## 背景说明
目前的前端工程项目中，使用Three.js来进行三维展示，三维模型是读取的OBJ模型。  
这种加载本地模型，首先需要进行模型的下载，然后需要进行模型的解析。如果觉得比较卡，可以从这两个角度入手  

## 模型下载的优化
因为目前限制下载速度的是网络带宽，因此缩小模型体积就称为了下载优化的最直接方法。  

### OBJ格式简介
[OBJ](https://en.wikipedia.org/wiki/Wavefront_.obj_file)是开放的三维模型格式，通过文本形式来展示模型上的各个点、面、体。如：  
```
g group_name
v 0 0 0
v 1 0 0
v 0 1 0
f -3 -2 -1
```
以上片文件段展示了体、体上三点以及一个面。OBJ中的面都是三角形，可以使用相对索引（如以上的-3、-2、-1），也可以使用绝对索引。  

### OBJ生成时的体积缩小
我们的OBJ文件是通过在其他建模软件中二次开发得到的。如上所述，面中的点可以使用相对索引，也可以使用绝对索引，而在真实的模型中，相邻面会共用大量的点。因此，我们在生成OBJ文件时，可以通过缓存点坐标的方式，来减少点的声明（即文件中v开头的行）。这样，便很大程度地减小了OBJ文件的体积。  
另外，我们对OBJ生成程序做了优化，可以手动指定需要精细化处理的构件：如果是一般构件，采用比较大的三角形；对于重要的构件，采取精细化处理，加密三角剖分。这样也可以减小一部分模型体积。  

### 文件的压缩与解压缩
文本文件的压缩率很高，因此可以考虑将OBJ文件压缩后在网络中传输，在接收后，再进行解压缩（如使用jszip等）。考虑到解压缩文件也需要一定的时间，因此这种方案需要在真实环境中酌情使用。我们服务器的带宽不大，测试发现解压缩文本速度很快，因此使用压缩包传输能够节省更多的时间，便采取了这种方法。如果网速够快，压缩较慢，则不宜采取改种方案。  

## 模型解析的优化
OBJ模型解析的过程就是解析文本，并将OBJ中的每个group生成一个Mesh。如果模型较复杂，那么解析的过程会很漫长。  

### 使用Web Worker预加载
JavaScript只是单线程处理，这种情况我们可以使用[Web Worker](https://developer.mozilla.org/zh-CN/docs/Web/API/Web_Workers_API/Using_web_workers)，这样就相当于并发地进行计算。由于各个group并无相互间的依赖，因此并发处理没有问题。我们目前使用Web Worker进行预加载，虽然加载的时间没有缩短，但提前处理，用户感觉起来就好像快了好多。  
使用Web Worker的一个问题是，Three.js中的Mesh对象不能够在线程之间传递（由于其某个部分的不可拷贝性）。对于这个问题，我们的解决方法是，只取Mesh中的Geometry部分，它是可以进行拷贝的。当然，我们的业务逻辑是只需要Geometry，后期自己指定材质进行渲染。如果你的业务逻辑需要整个的Mesh，那可能我的方法并不适用。  

### 使用第三方库
在搜索Web Worker时，搜到了[WWOBJLoader](https://github.com/kaisalmen/WWOBJLoader)，大概看了一下，是通过Web Worker并发地进行解析，提高模型解析速度。我们引入到工程中，实测能够节约一半的加载时间。  