# ä½¿ç”¨æ˜¾å¡åŠ é€Ÿ FFmpeg

## èƒŒæ™¯

æœ€è¿‘åšäº†ä¸€ä¸ªå±•ç¤ºå¤§å±é¡¹ç›®ï¼Œå…¶ä¸­éœ€è¦æ’­æ”¾å‡ è·¯ç›‘æ§è§†é¢‘ï¼Œä½¿ç”¨äº† FFmpeg å°†æ‹‰å–æµ·åº·æ‘„åƒå¤´çš„ rtsp æµï¼Œå¹¶è½¬ç æ¨ä¸º rtmp æµã€‚ç›‘æ§åŒºåŸŸä¸€å…±æœ‰å…­è·¯ç›‘æ§ï¼ŒåŒæ—¶å¤„ç†å…­è·¯è§†é¢‘ï¼ŒCPU å‹åŠ›æ¯”è¾ƒå¤§ï¼›æ­£å¥½éƒ¨ç½²çš„æœåŠ¡å™¨æœ‰ä¸€å—é—²ç½®çš„æ˜¾å¡ï¼ˆå·§äº†ä¸æ˜¯ ğŸ˜‚ï¼‰ï¼Œå°±ç ”ç©¶äº†ä¸€ä¸‹ä½¿ç”¨ GPU æ¥ååŠ© FFmpeg è¿›è¡Œè§†é¢‘å¤„ç†ã€‚  
å¤§æ¦‚æœç´¢äº†ä¸€ä¸‹ï¼Œå¦‚æœéœ€è¦ä½¿ç”¨ GPUï¼Œéœ€è¦è‡ªå·±ç¼–è¯‘ FFmpegï¼Œå¹¶ç¼–è¯‘ GPU åŠ é€Ÿç”¨çš„ç¼–è§£ç å™¨ã€‚è¿™æ ·ï¼Œåœ¨ä½¿ç”¨è¿‡ç¨‹ä¸­ï¼Œå°±å¯ä»¥é€‰æ‹©ä½¿ç”¨ GPU åŠ é€Ÿçš„ç¼–è§£ç å™¨ï¼Œè¾¾åˆ°ç›®çš„ã€‚  
æœåŠ¡å™¨æ˜¯ CentOS7ï¼Œæ˜¾å¡æ˜¯ TitanXPã€‚å®‰è£…æ—¶ï¼Œä¸»è¦å‚è€ƒ [FFmpeg çš„ç¼–è¯‘æ–‡æ¡£](https://trac.ffmpeg.org/wiki/CompilationGuide/Centos)å’Œ[Nvidia çš„ç›¸å…³æ–‡æ¡£](https://developer.nvidia.com/ffmpeg)ï¼›ä½¿ç”¨æ—¶ï¼Œå‚è€ƒ Nvidia æä¾›çš„[Using FFmpeg with NVIDIA GPU Hardware Acceleration.pdf](https://developer.nvidia.com/designworks/dl/Using_FFmpeg_with_NVIDIA_GPU_Hardware_Acceleration-pdf)ã€‚  
å…·ä½“çš„å®‰è£…ï¼Œæˆ‘åœ¨æ–‡æ¡£çš„åŸºç¡€ä¸Šæœ‰æ‰€ä¿®æ”¹ï¼Œè¿™é‡Œè®°å½•ä¸‹æ¥ã€‚

## FFmpeg çš„ç¼–è¯‘

### è·¯å¾„å‡†å¤‡

å‡†å¤‡ä¸€ä¸ªç©ºç›®å½• ffmpeg_sourcesï¼Œç”¨æ¥ä¸‹è½½ã€è§£å‹å„ç§æºç æ–‡ä»¶ï¼Œå¹¶ä½œä¸ºç¼–è¯‘æ—¶çš„å·¥ä½œç›®å½•ã€‚  
å®‰è£…ç›®å½•ï¼Œæˆ‘ä¹ æƒ¯å®‰è£…åˆ°`/usr/local/ffmpeg`ä¸­ï¼Œæ‰€ä»¥æå‰å»ºç«‹å¥½è¯¥æ–‡ä»¶å¤¹ï¼Œå¹¶å°†`/usr/local/ffmpeg/bin`ä½œä¸ºå®‰è£…çš„å„ç§å¯æ‰§è¡Œæ–‡ä»¶çš„è·¯å¾„ã€‚

### ä»£ç†å‡†å¤‡

åœ¨å®‰è£…è¿‡ç¨‹ä¸­ï¼Œéœ€è¦ä¸‹è½½è®¸å¤šæºç åŒ…ï¼Œå»ºè®®æŒ‚ä¸Šå…¨å±€ä»£ç†ï¼Œå¦åˆ™ä¼šæ¯”è¾ƒéš¾å—ã€‚æˆ‘æœ¬æœºçš„ 1080 ç«¯å£å·²ç»é…ç½®äº† HTTP ä»£ç†ã€‚

```shell
export https_proxy=http://127.0.0.1:1080 http_proxy=http://127.0.0.1:1080
```

### ç¼–è¯‘å·¥å…·å‡†å¤‡

æŒ‰ç…§æ–‡æ¡£é‡Œçš„è¯´æ˜ï¼Œæˆ‘ä»¬å®‰è£…ä¸‹é¢è¿™äº›å·¥å…·ï¼ˆå¤§éƒ¨åˆ†åº”è¯¥éƒ½å®‰è£…è¿‡äº†ï¼‰

```shell
sudo yum install autoconf automake bzip2 bzip2-devel cmake freetype-devel gcc gcc-c++ git libtool make mercurial pkgconfig zlib-devel
```

### æ˜¾å¡å·¥å…·å‡†å¤‡

å®‰è£…æ˜¾å¡é©±åŠ¨å’Œ CUDA toolkitã€‚æˆ‘è¿™é‡Œæ˜¾å¡æ˜¯ TITAN Xï¼Œé©±åŠ¨ç‰ˆæœ¬ 430.64ï¼ŒCUDA ç‰ˆæœ¬ 10.1

### NASM ç¼–è¯‘å®‰è£…

NASM ç”¨äºåç»­ä¸€äº›åº“çš„ç¼–è¯‘ï¼ˆæˆ–è€…è¯´æ˜¯æ±‡ç¼–ï¼Ÿï¼‰è¿‡ç¨‹ã€‚ç¼–è¯‘å®‰è£…åï¼Œè®¾ç½®è½¯è¿æ¥ä»¥ç›´æ¥è°ƒç”¨ã€‚

```shell
cd ~/ffmpeg_sources
curl -O -L https://www.nasm.us/pub/nasm/releasebuilds/2.14.02/nasm-2.14.02.tar.bz2
tar xjvf nasm-2.14.02.tar.bz2
cd nasm-2.14.02
./autogen.sh
./configure --prefix=/usr/local/ffmpeg --bindir=/usr/local/ffmpeg/bin
make
sudo make install
sudo ln -s /usr/local/ffmpeg/bin/nasm /usr/bin/nasm
nasm --version
```

### YASM ç¼–è¯‘å®‰è£…

å’Œ NASM ç±»ä¼¼ï¼ŒYASM ç”¨äºåç»­ä¸€äº›åº“çš„ç¼–è¯‘ï¼ˆæˆ–è€…è¯´æ˜¯æ±‡ç¼–ï¼Ÿï¼‰è¿‡ç¨‹ã€‚ç¼–è¯‘å®‰è£…åï¼Œè®¾ç½®è½¯è¿æ¥ä»¥ç›´æ¥è°ƒç”¨ã€‚

```shell
cd ~/ffmpeg_sources
curl -O -L https://www.tortall.net/projects/yasm/releases/yasm-1.3.0.tar.gz
tar xzvf yasm-1.3.0.tar.gz
cd yasm-1.3.0
./configure --prefix=/usr/local/ffmpeg --bindir=/usr/local/ffmpeg/bin
make
sudo make install
sudo ln -s /usr/local/ffmpeg/bin/yasm /usr/bin/yasm
yasm --version
```

### libx264 ç¼–è¯‘å®‰è£…

libx264 æ˜¯ H.264 è§†é¢‘çš„ç¼–ç å™¨ã€‚å¦‚æœä¹‹å‰çš„ nasm æ²¡æœ‰å®‰è£…å¥½ï¼Œè¿™é‡Œçš„å®‰è£…ä¼šæŠ¥é”™ã€‚  
å¦å¤–ï¼Œæœ‰æ—¶å€™ git clone ä¼šæœ‰ç½‘ç»œé—®é¢˜ï¼Œå¯ä»¥ç›´æ¥ä¸‹è½½ä»£ç åŒ…å¹¶è§£å‹ `wget https://code.videolan.org/videolan/x264/-/archive/master/x264-master.tar.bz2`

```shell
cd ~/ffmpeg_sources
git clone --depth 1 https://code.videolan.org/videolan/x264.git
cd x264
PKG_CONFIG_PATH=/usr/local/ffmpeg/lib/pkgconfig ./configure --prefix=/usr/local/ffmpeg --bindir=/usr/local/ffmpeg/bin --enable-static
make
sudo make install
```

### libx265 çš„å®‰è£…

æˆ‘ç”¨ä¸åˆ°è¿™ä¸ªï¼Œå°±æ²¡è£…â€¦â€¦å¥½åƒä¸‹è½½æ—¶å€™è¿˜æœ‰ä¸€äº›åè®®å•¥çš„é—®é¢˜ã€‚

### libfdk_aac ç¼–è¯‘å®‰è£…

AAC éŸ³é¢‘ç¼–ç å™¨ï¼Œè™½ç„¶ç”¨ä¸åˆ°ï¼Œä½†æ˜¯è£…èµ·æ¥ä¸é‚£ä¹ˆè´¹åŠ²ï¼Œå°±ä¹Ÿè£…äº†ã€‚

```shell
cd ~/ffmpeg_sources
git clone --depth 1 https://github.com/mstorsjo/fdk-aac
cd fdk-aac
autoreconf -fiv
./configure --prefix=/usr/local/ffmpeg --disable-shared
make
sudo make install
```

### libmp3lame ç¼–è¯‘å®‰è£…

MP3 éŸ³é¢‘ç¼–ç å™¨ï¼Œå°±è£…å§â€¦â€¦

```shell
cd ~/ffmpeg_sources
curl -O -L https://downloads.sourceforge.net/project/lame/lame/3.100/lame-3.100.tar.gz
tar xzvf lame-3.100.tar.gz
cd lame-3.100
./configure --prefix=/usr/local/ffmpeg --bindir=/usr/local/ffmpeg/bin --disable-shared --enable-nasm
make
sudo make install
```

### libopus ç¼–è¯‘å®‰è£…

Opus éŸ³é¢‘ç¼–è§£ç å™¨ã€‚

```shell
cd ~/ffmpeg_sources
curl -O -L https://archive.mozilla.org/pub/opus/opus-1.3.1.tar.gz
tar xzvf opus-1.3.1.tar.gz
cd opus-1.3.1
./configure --prefix=/usr/local/ffmpeg --disable-shared
make
sudo make install
```

### libvpx

VP8/VP9 è§†é¢‘ç¼–è§£ç å™¨

```shell
cd ~/ffmpeg_sources
git clone --depth 1 https://chromium.googlesource.com/webm/libvpx.git
cd libvpx
./configure --prefix=/usr/local/ffmpeg --disable-examples --disable-unit-tests --enable-vp9-highbitdepth --as=yasm
make
sudo make install
```

### ffnvcodec å®‰è£…

è¿™ä¸ªå°±æ˜¯ Nvidia æä¾›çš„ç¡¬ä»¶ç¼–è§£ç ç›¸å…³ SDKã€‚å®‰è£…æ—¶éœ€è¦æ³¨æ„é€‰æ‹©ä¸æ˜¾å¡é©±åŠ¨ç›¸é…å¥—çš„ç‰ˆæœ¬ï¼Œåœ¨`https://github.com/FFmpeg/nv-codec-headers`çš„ README ä¸­å¯ä»¥æŸ¥çœ‹ã€‚åƒæˆ‘è¿™é‡Œ 430.64 ç‰ˆæœ¬çš„é©±åŠ¨ï¼Œå°±åªèƒ½ä½¿ç”¨ 9.0 ç‰ˆæœ¬çš„ SDKã€‚  
å¦å¤–ï¼Œgit clone ä¸‹æ¥ï¼ŒMakefile æ˜¯äººå®¶å†™å¥½çš„ï¼Œéœ€è¦ç¼–è¾‘ä¸€ä¸‹ï¼ŒæŠŠ PREFIX æ”¹æˆæˆ‘ä»¬çš„`/usr/local/ffmpeg`

```shell
cd ~/ffmpeg_sources
git clone -b sdk/9.0 https://github.com/FFmpeg/nv-codec-headers.git
cd nv-codec-headers
vim Makefile
sudo make install
```

### FFmpeg çš„ç¼–è¯‘å®‰è£…

å„ç§ç¼–è§£ç å™¨éƒ½å‡†å¤‡å¥½äº†ï¼Œæœ€åè¦ç¼–è¯‘ FFmpegã€‚è¿™é‡Œæˆ‘ä¸‹è½½çš„æ˜¯ 4.3.1 çš„ç¨³å®šç‰ˆã€‚

```shell
cd ~/ffmpeg_sources
wget https://ffmpeg.org/releases/ffmpeg-4.3.1.tar.bz2
tar xjvf ffmpeg-4.3.1.tar.bz2
cd ffmpeg-4.3.1
PATH="/usr/local/ffmpeg/bin:$PATH" PKG_CONFIG_PATH=/usr/local/ffmpeg/lib/pkgconfig ./configure \
  --prefix=/usr/local/ffmpeg \
  --pkg-config-flags="--static" \
  --extra-cflags="-I/usr/local/ffmpeg/include -I/usr/local/cuda/include" \
  --extra-ldflags="-L/usr/local/ffmpeg/lib -L/usr/local/cuda/lib64" \
  --extra-libs=-lpthread \
  --extra-libs=-lm \
  --bindir=/usr/local/ffmpeg/bin \
  --enable-gpl \
  --enable-libfdk_aac \
  --enable-libfreetype \
  --enable-libmp3lame \
  --enable-libopus \
  --enable-libvpx \
  --enable-libx264 \
  --enable-cuda-nvcc \
  --enable-cuvid \
  --enable-nvenc \
  --enable-libnpp \
  --enable-nonfree
make -j 8
sudo make install
sudo ln -s /usr/local/ffmpeg/bin/ffmpeg /usr/bin/ffmpeg
sudo ln -s /usr/local/ffmpeg/bin/ffprobe /usr/bin/ffprobe
ffmpeg -version
ffprobe -version
```

### è§£é™¤ NVENC çš„å¹¶å‘é™åˆ¶

ä½¿ç”¨ GPU è¿›è¡Œè§†é¢‘ç¼–ç æœ‰ç€å¹¶å‘æ•°çš„é™åˆ¶ï¼Œ[åœ¨è¿™é‡Œ](https://developer.nvidia.com/video-encode-decode-gpu-support-matrix#Encoder)å¯ä»¥çœ‹åˆ°ï¼ŒGeForce ç³»åˆ—å„ç§æ˜¾å¡å¤§éƒ¨åˆ†é™åˆ¶ä¸º 3 è·¯å¹¶å‘ã€‚æ®è¯´è¿™ä¸ªé™åˆ¶å¹¶ä¸æ˜¯ç¡¬ä»¶æœ¬èº«çš„é™åˆ¶ï¼Œè€Œæ˜¯ NVIDIA ä¸ºäº†è®©å¤§å®¶ä¹°æ›´é«˜ç«¯çš„æ˜¾å¡è€Œåšçš„æ‰‹è„šã€‚æ‰€ä»¥è¿™é‡Œç¥­å‡ºæˆ‘ä»¬ç»å…¸çš„å›½é™…é—®å€™ï¼š  
![FUCK_NVIDIA](./fuck-nvidia.jpg)
è§£å†³çš„åŠæ³•ä¹Ÿå¾ˆç®€å•ï¼Œ[æœ‰åŒå¿—å·²ç»åˆ¶ä½œäº†è¡¥ä¸](https://github.com/keylase/nvidia-patch)ï¼Œå¯ä»¥æ‰“ç ´è¿™ä¸€é™åˆ¶ï¼Œæˆ‘ä»¬é€‰æ‹©å’Œé©±åŠ¨ç¨‹åºåŒ¹é…çš„ç‰ˆæœ¬ä¸‹è½½å®‰è£…å°±å¯ä»¥ã€‚  
æœ‰æ—¶å€™ä¹Ÿä¼šé‡åˆ°æ¯”è¾ƒæ–°çš„æ˜¾å¡é©±åŠ¨è¿˜æ²¡æœ‰è¡¥ä¸ï¼Œè¿™æ—¶å€™å¯ä»¥ä»”ç»†è§‚å¯Ÿï¼Œä¸´è¿‘ç‰ˆæœ¬çš„è¡¥ä¸ä¸€èˆ¬æ²¡æœ‰å˜åŒ–ï¼Œç¨å¾®æ”¹ä¸€ä¸‹ sh è„šæœ¬ï¼Œä¹Ÿå¯ä»¥ç”¨ã€‚è¿™ä¸ªä¸€èˆ¬ä¸å¤ªæ‹¼äººå“ï¼Œæˆ‘è¯•è¿‡ã€‚

```shell
cd ~/ffmpeg_sources
git clone https://github.com/keylase/nvidia-patch.git
cd nvidia-patch
sudo bash ./patch.sh
```

## FFmpeg çš„ä½¿ç”¨

ä½¿ç”¨æ˜¾å¡ååŠ©è¿›è¡Œç¼–è§£ç æ—¶ï¼Œå¯ä»¥å‚è€ƒ Nvidia å®˜æ–¹ç»™å‡ºçš„[è¿™ä»½æ–‡æ¡£](https://developer.nvidia.com/designworks/dl/Using_FFmpeg_with_NVIDIA_GPU_Hardware_Acceleration-pdf)(éœ€è¦æ³¨å†Œä¸º Nvidia å¼€å‘è€…)ã€‚è¿™é‡Œä¸¾å‡ ä¸ªæˆ‘è‡ªå·±ä½¿ç”¨çš„ä¾‹å­ã€‚

- æ”¾ç‰‡å„¿ï¼Œä½¿ç”¨æ˜¾å¡è¿›è¡Œè§£ç å’Œç¼–ç ï¼Œå¹¶æ¨é€ RTMP æµï¼š

```shell
ffmpeg -y -hwaccel cuvid -vcodec h264_cuvid -hwaccel_output_format cuda -re -i sexy-av.mp4 -vcodec h264_nvenc -an -preset llhp -zerolatency 1 -f flv -g 5 rtmp://xxx.xxx.xxx.xxx/live/av
```

- æ‹‰æ¨æµï¼Œæ‹‰å–æµ·åº·æ‘„åƒå¤´çš„ RTSP è§†é¢‘æµï¼Œä½¿ç”¨æ˜¾å¡è§£ç å†ç¼–ç å¹¶æ¨ RTMPï¼š

```shell
ffmpeg -y -hwaccel cuvid -vcodec h264_cuvid -hwaccel_output_format cuda -rtsp_transport tcp -i rtsp://username:passwd@xxx.xxx.xxx.xxx -vcodec h264_nvenc -an -preset llhp -zerolatency 1 -f flv -g 5 rtmp://xxx.xxx.xxx.xxx/live/cam
```

## æ•ˆæœ

æˆ‘ä»¬åŠå…¬å®¤ä½¿ç”¨äº†å¤šè·¯æµ·åº·ç›‘æ§è§†é¢‘ï¼Œè¿˜æœ‰éƒ¨åˆ†éœ€è¦åœ¨å¤§å±ä¸Šå¾ªç¯æ’­æ”¾çš„ç‰‡å„¿ï¼ŒåŠ èµ·æ¥ä¸€å…±æœ‰ 19 è·¯è§†é¢‘æ•°æ®ï¼ŒåŒæ—¶è·‘èµ·æ¥æ˜¾å¡å ç”¨ç‡ä¸é«˜ï¼ŒCPU ä¹ŸåŸºæœ¬æ²¡æœ‰å ç”¨ï¼Œéå¸¸å®Œç¾ï¼Œè¾¾åˆ°äº†åºŸç‰©åˆ©ç”¨çš„æ ‡å‡†ã€‚

![æ˜¾å¡åˆ©ç”¨](./GPU.png)
![CPUåˆ©ç”¨](./TOP.png)
